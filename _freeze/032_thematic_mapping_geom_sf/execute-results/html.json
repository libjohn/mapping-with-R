{
  "hash": "e4f86dd6742f0e8565c7f81c55befc17",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Thematic Mapping with geom_sf\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)       \nlibrary(readxl)\nlibrary(tigris)\nlibrary(sf)\nlibrary(viridis)\n```\n:::\n\n\n## Shapefiles as sf\n\nUse the `tigris` package to get Census Tiger shapefiles for census geographies. Coastal boundaries can be gathered with the tigris argument: `cb = TRUE`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_geo <- tigris::states(class = \"sf\", cb = TRUE) %>% \n  shift_geometry()\n```\n:::\n\n\n``` r\nus_geo <- tigris::states(class = \"sf\", cb = TRUE)) %>% \n  shift_geometry()\n```\n\n## Get BLS data\n\nIn additon to shapefiles, the wage data used in this example comes from from the Bureau of Labor Statistics. These data are stored in an excel file in the `data` directory of the [repository](https://github.com/libjohn/mapping-with-R): `data/OES_Report.xlsx`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSalary4Helpers <- \n  read_excel(\"data/OES_Report.xlsx\",\n             col_types = c(\"text\", \"numeric\"), \n             skip = 4)\n\nSalary4Helpers\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Area Name\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Annual mean wage(2)\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Alabama(0100000)\",\"2\":\"38080\"},{\"1\":\"Alaska(0200000)\",\"2\":\"46050\"},{\"1\":\"Arizona(0400000)\",\"2\":\"34560\"},{\"1\":\"Arkansas(0500000)\",\"2\":\"40480\"},{\"1\":\"California(0600000)\",\"2\":\"64320\"},{\"1\":\"Colorado(0800000)\",\"2\":\"43480\"},{\"1\":\"Connecticut(0900000)\",\"2\":\"60450\"},{\"1\":\"Delaware(1000000)\",\"2\":\"54450\"},{\"1\":\"District of Columbia(1100000)\",\"2\":\"57210\"},{\"1\":\"Florida(1200000)\",\"2\":\"43410\"},{\"1\":\"Georgia(1300000)\",\"2\":\"52750\"},{\"1\":\"Guam(6600000)\",\"2\":\"40080\"},{\"1\":\"Hawaii(1500000)\",\"2\":\"57290\"},{\"1\":\"Idaho(1600000)\",\"2\":\"39580\"},{\"1\":\"Illinois(1700000)\",\"2\":\"53240\"},{\"1\":\"Indiana(1800000)\",\"2\":\"42100\"},{\"1\":\"Iowa(1900000)\",\"2\":\"45380\"},{\"1\":\"Kansas(2000000)\",\"2\":\"41050\"},{\"1\":\"Kentucky(2100000)\",\"2\":\"38130\"},{\"1\":\"Louisiana(2200000)\",\"2\":\"37270\"},{\"1\":\"Maine(2300000)\",\"2\":\"59360\"},{\"1\":\"Maryland(2400000)\",\"2\":\"47560\"},{\"1\":\"Massachusetts(2500000)\",\"2\":\"44960\"},{\"1\":\"Michigan(2600000)\",\"2\":\"49420\"},{\"1\":\"Minnesota(2700000)\",\"2\":\"49310\"},{\"1\":\"Mississippi(2800000)\",\"2\":\"34880\"},{\"1\":\"Missouri(2900000)\",\"2\":\"35510\"},{\"1\":\"Montana(3000000)\",\"2\":\"37710\"},{\"1\":\"Nebraska(3100000)\",\"2\":\"36620\"},{\"1\":\"Nevada(3200000)\",\"2\":\"57460\"},{\"1\":\"New Hampshire(3300000)\",\"2\":\"51320\"},{\"1\":\"New Jersey(3400000)\",\"2\":\"71600\"},{\"1\":\"New Mexico(3500000)\",\"2\":\"37420\"},{\"1\":\"New York(3600000)\",\"2\":\"56430\"},{\"1\":\"North Carolina(3700000)\",\"2\":\"46490\"},{\"1\":\"North Dakota(3800000)\",\"2\":\"50270\"},{\"1\":\"Ohio(3900000)\",\"2\":\"41190\"},{\"1\":\"Oklahoma(4000000)\",\"2\":\"35430\"},{\"1\":\"Oregon(4100000)\",\"2\":\"46330\"},{\"1\":\"Pennsylvania(4200000)\",\"2\":\"37600\"},{\"1\":\"Puerto Rico(7200000)\",\"2\":\"23050\"},{\"1\":\"Rhode Island(4400000)\",\"2\":\"47420\"},{\"1\":\"South Carolina(4500000)\",\"2\":\"34680\"},{\"1\":\"South Dakota(4600000)\",\"2\":\"36980\"},{\"1\":\"Tennessee(4700000)\",\"2\":\"35540\"},{\"1\":\"Texas(4800000)\",\"2\":\"42790\"},{\"1\":\"Utah(4900000)\",\"2\":\"47140\"},{\"1\":\"Vermont(5000000)\",\"2\":\"40150\"},{\"1\":\"Virginia(5100000)\",\"2\":\"49250\"},{\"1\":\"Washington(5300000)\",\"2\":\"51980\"},{\"1\":\"West Virginia(5400000)\",\"2\":\"30920\"},{\"1\":\"Wisconsin(5500000)\",\"2\":\"46220\"},{\"1\":\"Wyoming(5600000)\",\"2\":\"56110\"},{\"1\":\"NA\",\"2\":\"NA\"},{\"1\":\"(2)Annual wages have been calculated by multiplying the hourly mean wage by 2,080 hours.\",\"2\":\"NA\"},{\"1\":\"NA\",\"2\":\"NA\"},{\"1\":\"SOC code: Standard Occupational Classification code -- see http://www.bls.gov/soc/home.htm\",\"2\":\"NA\"},{\"1\":\"Date extracted on :Sep 25, 2017\",\"2\":\"NA\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## Wrangle the data\n\nUsing the [`stringr` package](https://stringr.tidyverse.org) we can extract the text of the state names from the state code by leveraging regular expressions (i.e. regex) pattern matching techniques with stringr::str_extract().\n\n\n::: {.cell}\n\n```{.r .cell-code}\nBlsWage_ToJoin <- Salary4Helpers %>% \n  rename(wages = \"Annual mean wage(2)\") %>% \n  mutate(State = str_extract(`Area Name`, \"\\\\w+.*(?=\\\\()\")) %>% \n  drop_na(wages) %>% \n  select(State, wages)\n```\n:::\n\n\n## Join data\n\nUse the `dplyr::left_join` function to append BLS variable to the `sf` tibble (data frame).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nHelperShapeObject <- us_geo %>% \n  left_join(BlsWage_ToJoin,\n            by = c(\"NAME\" = \"State\"))\n```\n:::\n\n\n## 50 states\n\nFilter to only the 50 US states + D.C.\n\nAlaska and Hawaii were shifted and rescaled using `tigris::shift_geometry()`, above.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontiguous_states <- HelperShapeObject %>% \n  filter(GEOID < 60) \n```\n:::\n\n\n## ggplot2 with geom_sf and viridis\n\nggplot2 is one of the more popular and broadly distributed graphics packages used in the R community. ([Learn more](https://rfun.library.duke.edu/#portfolio) about ggplot2.\n\nIn this plot I **reversed** the *direction* of the color scale. Reversing the color pallette's direction is not a visualization best practice, but I use this approach to demonstrate the `direction` argument.\n\nUse a pleasing projection. In this case assign the CRS projection to '5070'\n\n> `coord_sf(crs = 5070)`Â  Help with [projection/CRS](https://guides.library.duke.edu/r-geospatial/CRS)\\\n> `coords_sf(datum = NA)` Remove gridlines, i.e [graticules](https://en.wikipedia.org/wiki/Graticule)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontiguous_states %>% \n  ggplot(aes(fill = wages, color = wages)) +\n  geom_sf() +\n  coord_sf(crs = 5070, datum = NA) +\n  scale_fill_viridis(direction = -1, label = scales::dollar) + \n  scale_color_viridis(direction = -1, label = scales::dollar) +\n  labs(title = \"Annual Mean Wages by State\",\n       subtitle = \"Mental Health and Substance Abuse Social Workers(SOC Code211023)\", \n       caption = \"Data Source: BLS.gov - Occupational Employment Statistics ; 2016\")\n```\n\n::: {.cell-output-display}\n![](032_thematic_mapping_geom_sf_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## End Notes\n\nThis session inspired by https://www.computerworld.com/article/3175623/data-analytics/mapping-in-r-just-got-a-whole-lot-easier.html\n",
    "supporting": [
      "032_thematic_mapping_geom_sf_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}