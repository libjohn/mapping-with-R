{
  "hash": "9878c563b77bc6af06dbbd3348e06a1c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Faceted Thematic Mapping\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)       \nlibrary(readxl)\nlibrary(tigris)          # Get Census Geography Poloygons\nlibrary(sf)\nlibrary(tidycensus)\n```\n:::\n\n\n## Shapefiles as sf\n\nUsing the `tigris` package get Census Tiger shapefiles for census geographies. Tigris will return the shapefile in the `sf`, or simple features, format.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_geo <- tigris::states(class = \"sf\", cb = TRUE) %>%   #cb is a more generalized, less detailed file.\n  shift_geometry() %>% \n  filter(as.numeric(GEOID) < 60)\n```\n:::\n\n\n## Get BLS data\n\nI've already downloaded and stored some data from the Bureau of Labor Statistics. Those data are stored in an excel file in the `data` directory of the github repository: `data/OES_Report.xlsx`. **The goal is to attach this data to the previously downloaded shapefiles.**\n\nBut you may be interested in how I gathered the data. below are some summary notes documenting my steps of gathering the data from the Bureau of Labor Statistics.\n\nhttps://data.bls.gov/oes/#/occGeo/One%20occupation%20for%20multiple%20geographical%20areas\n\n-   One occupation for multiple geographical areas\n\n    -   Mental Health and Substance Abuse Social Workers (Also, Secondary School Teacher, Waiter, Legislator, and Paralegals)\n\n        -   State\n\n        -   All States in this list\n\n        -   Annual Mean wage\n\n            -   Excel\n\n### Import the data into R\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_xl_files <- fs::dir_ls(path = \"data\", glob = \"*.xlsx\")\n\nmy_df <- my_xl_files %>% \n  map_dfr(read_excel, \n          col_types = c(\"text\", \"numeric\"), \n          skip = 4, \n          .id = \"sheet\")\n\nstate_names <- us_geo %>% \n  select(NAME) %>% \n  st_drop_geometry() \n```\n:::\n\n\n### Wrangle the data\n\nBefore we join the BLS data to the shapefile `us_geo` we need to transform BLS data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_df <- my_df %>% \n  rename(area = \"Area Name\",\n         wages = \"Annual mean wage(2)\",\n         type = sheet) %>% \n  mutate(State = str_extract(area, '.*(?=\\\\()')) %>% \n  mutate(type = str_extract(type, \"(?<=data/OES_)\\\\w+\"))\n```\n:::\n\n\n### Missing data\n\nSome of the BLS data are missing making it hard to visualize. As a remedy to this problem we will wrangle the data by preserving shape geometry even for states without any wage data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmissing_states_legislators <- state_names %>% \n  anti_join(my_df %>% filter(type == \"legislator\"), \n            by = c(\"NAME\" = \"State\")) %>% \n  mutate(type = \"legislator\") %>% \n  rename(State = NAME)\n\nmissing_states_legislators\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"State\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"type\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"South Dakota\",\"2\":\"legislator\"},{\"1\":\"Kentucky\",\"2\":\"legislator\"},{\"1\":\"Vermont\",\"2\":\"legislator\"},{\"1\":\"District of Columbia\",\"2\":\"legislator\"},{\"1\":\"Maine\",\"2\":\"legislator\"},{\"1\":\"North Carolina\",\"2\":\"legislator\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_df <- my_df %>% \n  bind_rows(missing_states_legislators)\n```\n:::\n\n\n### Join data\n\nUsing the `dplyr::left_join`, merge BLS data with the `us_geo` geometry, i.e. the shapefile object\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_df <- us_geo %>% \n  left_join(my_df, by = c(\"NAME\" = \"State\"))\n```\n:::\n\n\n## Get census data -- tidycensus\n\n### Identify and pick census variables\n\nIf you're not sure what 2015 ACS Census data variables you need, you'll want to investigate the variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvariables_census <- load_variables(2015, \"acs5\", cache = TRUE)\n```\n:::\n\n\nI'm using Median income.\n\n-   B01003_001E = Total Population\\\n-   B06011_001E = Median income in the past 12 months\n\n*Note: I realize mean and median are not the same measure. This is a demonstration of procedure, not a recommendation for research practice and data comparison. Of course, you will be more rigorous with your own research.*\n\n### Get ACS median income\n\nNow that I know the Census ACS variable, I can use the `tidycensus::get_acs()` function to gather the mean income variable for each state, along with the geometry (i.e. shapefiles).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nus_pop <- \n  get_acs(geography = \"state\",\n          variables = \"B06011_001E\",\n          geometry = TRUE)  %>% \n  shift_geometry()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nGetting data from the 2017-2021 5-year ACS\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nDownloading feature geometry from the Census website.  To cache shapefiles for use in future sessions, set `options(tigris_use_cache = TRUE)`.\n```\n\n\n:::\n\n```{.r .cell-code}\nus_pop <- us_pop %>% \n  mutate(type = \"USA Median Income\") %>% \n  rename(wages = estimate) \n```\n:::\n\n\n### Append Census data\n\nNow combine the tidycensus data and geometry (i.e. `us_pop` variable data & shapefiles) with the BLS data and previously associate shapefiles gatheried via `tigris::states()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_df <- bind_rows(my_df, us_pop)\n```\n:::\n\n\n### More munging\n\nMake the category variable a categorical factor with levels. This will improve the order of the facets when displayed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndisplay_levels <- c(\"USA Median Income\", \"Legislator\", \n                    \"Paralegals\", \"Substance Abuse Counselor\", \n                    \"Teacher\", \"Waiters\")\n\nmy_df <- my_df %>% \n  mutate(category = case_when(\n    type == \"USA Median Income\" ~ \"USA Median Income\",\n    type == \"legislator\" ~ \"Legislator\",\n    type == \"paralegals\" ~ \"Paralegals\",\n    type == \"Report\" ~ \"Substance Abuse Counselor\",\n    type == \"secondary_school_teacher\" ~ \"Teacher\",\n    type == \"waiters\" ~ \"Waiters\"\n  )) %>% \n  mutate(category = factor(category, display_levels))\n```\n:::\n\n\n### Display map\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_df %>%\n  ggplot(aes(fill = wages, color = wages)) +\n  geom_sf() +\n  coord_sf(crs = 5070, datum = NA) +\n  scale_fill_viridis_c(labels = c(\"$20K\", \"$55K\", \"$87K\"), breaks = c(20000, 55000, 87000)) +\n  scale_color_viridis_c(labels = c(\"$20K\", \"$55K\", \"$87K\"), breaks = c(20000, 55000, 87000)) +\n  facet_wrap(~ category, \n             nrow = 3, ncol = 2) +\n  theme(legend.position = \"top\") +\n  labs(title = \"2015 Mean USA Wages by Professions\",\n       subtitle = \"A comparison of BLS mean income with Census median income\",\n       color = \"\", fill = \"\",\n       caption = \"Source: BLS & Census\") \n```\n\n::: {.cell-output-display}\n![](038_facets_wrap_thematic_mapping_files/figure-html/makethemap-1.svg){width=768}\n:::\n:::\n\n\n### Save map\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggsave(\"facet_map.svg\", width = 8, height = 9, units = \"in\")\n```\n:::\n",
    "supporting": [
      "038_facets_wrap_thematic_mapping_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}